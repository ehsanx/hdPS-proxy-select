---
title: "Summary of Performance Measures for Normal Scenario"
author: "Ehsan, Yang"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
  pdf_document:
    toc: true
    toc_depth: 2
---


## Read data

- Keep the data in the `results` folder
- make sure working directory is updated

```{r data}
library(rsimsum)
library(dplyr)
library(tidyr)
library(kableExtra)
library(reshape2)
library(ggplot2)

load("results/scenario/bross.RData")
load("results/scenario/hybrid.RData")
load("results/scenario/lasso.RData")
load("results/scenario/enet.RData")
load("results/scenario/ga.RData")
load("results/scenario/xgboost.RData")
load("results/scenario/rf.RData")
load("results/scenario/forward.RData")
load("results/scenario/backward.RData")

ind <- which(!is.na(RD_bross[,1]))

est_bross    <- RD_bross[ind,]
est_hybird   <- RD_hybrid[ind,]
est_lasso    <- RD_lasso[ind,]
est_enet     <- RD_enet[ind,]
est_ga       <- RD_ga[ind,]
est_xgboost  <- RD_xgboost[ind,]
est_rf       <- RD_rf[ind,]
est_forward  <- RD_forward[ind,]
est_backward <- RD_backward[ind,]

est_bross$model    <- "bross"
est_hybird$model   <- "hybrid"
est_lasso$model    <- "lasso"
est_enet$model     <- "enet"
est_ga$model       <- "ga"
est_xgboost$model  <- "xgboost"
est_rf$model       <- "rf"
est_forward$model  <- "forward"
est_backward$model <- "backward"
```


## Combine data into 1 data

Make sure table provides same numbers for all model. For full analysis, all should be 766.

```{r bind}
est <- rbind(est_bross, est_hybird, est_lasso, est_enet, 
             est_ga, est_xgboost, est_rf,
             est_forward, est_backward)

est$model <- as.factor(est$model)
levels<- c("bross", "hybrid", "lasso", "enet", "ga", "xgboost", "rf", "forward", "backward")
est$model <- factor(est$model, levels = levels)
levels(est$model)
```


## Analyze simulated data

```{r sim}
theta <- 0
s1 <- simsum(data = est, estvarname = "RD", true = theta, se = "SE", 
             methodvar = "model", ref = "bross", x = TRUE)
ss1 <- summary(s1)
ss1
```

## Present results in a Table

change `kable(final_df, format = "html" ...` to `kable(final_df, format = "latex"` to get the latex codes.

```{r table, warning=FALSE, message=FALSE, eval=FALSE}
extract_metric <- function(metric) {
  # Function to extract and format metric data
  metric_data <- ss1$summ[ss1$summ$stat == metric, c("model", "est", "mcse")]
  metric_data$est <- sprintf("%.4f", metric_data$est)
  metric_data$mcse <- sprintf("%.4f", metric_data$mcse)
  metric_data$formatted <- paste0(metric_data$est, " (", metric_data$mcse, ")")
  metric_data <- metric_data[, c("model", "formatted")]
  names(metric_data) <- c("model", metric)
  return(metric_data)
}

metrics <- c("bias", "empse", "mse", "modelse", "cover", "becover")
formatted_metrics <- lapply(metrics, extract_metric)
combined_df <- Reduce(function(x, y) merge(x, y, by = "model"), formatted_metrics)
final_df <- combined_df %>%
  gather(key = "metric", value = "value", -model) %>%
  spread(key = "model", value = "value")
final_df$metric <- recode(final_df$metric,
                          bias = "Bias",
                          empse = "Empirical SE",
                          mse = "MSE",
                          modelse = "Model-based SE",
                          cover = "Coverage",
                          becover = "Bias-eliminated Coverage")
final_df <- final_df %>%
  arrange(factor(metric, levels = c("Bias", "Empirical SE", "MSE", "Model-based SE", "Coverage", "Bias-eliminated Coverage"))) %>%
  rename(`Performance Measure` = metric)
names(final_df) <- c("Performance Measure", levels)
kable(final_df, format = "html", booktabs = TRUE, linesep = "", col.names = c("Performance Measure", levels),
      caption = "Summary of Performance Measures") %>%
  kable_styling(latex_options = c("striped", "hold_position"), full_width = FALSE)
```


## Present results in Figures

All figures also saved in the `images` folder.

```{r plots, warning=FALSE, message=FALSE}
custom_theme <- theme_minimal() + 
  theme(
    panel.background = element_rect(fill = "white"),  
    panel.grid.major = element_blank(),              
    panel.grid.minor = element_blank(),              
    legend.position = "bottom"                      
  )

unique(ss1$summ$stat)
autoplot(s1, type = "lolly", stats = "nsim")+ custom_theme
autoplot(s1, type = "lolly", stats = "bias")+ custom_theme  + labs(x = "Bias")
ggsave(filename = "images/scenario/bias.png")
autoplot(s1, type = "lolly", stats = "relerror")+ custom_theme  + labs(x = "Relative % error")
autoplot(s1, type = "lolly", stats = "cover")+ custom_theme  + labs(x = "95% coverage")
ggsave(filename = "images/scenario/cover.png")
autoplot(s1, type = "lolly", stats = "becover")+ custom_theme  + labs(x = "95% bias-eliminated coverage")
ggsave(filename = "images/scenario/becover.png")
autoplot(s1, type = "lolly", stats = "modelse")+ custom_theme + labs(x = "Model SE")
ggsave(filename = "images/scenario/modelse.png")
autoplot(s1, type = "lolly", stats = "empse")+ custom_theme  + labs(x = "Empirical SE")
ggsave(filename = "images/scenario/empse.png")
autoplot(s1, type = "lolly", stats = "mse")+ custom_theme + labs(x = "MSE")
autoplot(s1, type = "lolly", stats = "relprec")+ custom_theme
autoplot(s1, type = "lolly", stats = "power")+ custom_theme
zip_plot <- autoplot(s1, type = "zip", zoom = 0.5) + custom_theme
dashed_line <- geom_hline(yintercept = 0.95, linetype = "dashed", color = "blue")
zip_plot + 
  annotate("segment", x = -Inf, xend = Inf, y = 0.95, yend = 0.95, linetype = "dashed", color = "blue") +
  dashed_line
ggsave(filename = "images/scenario/zip.png")
```

## SE comparison

```{r plotSE, warning=FALSE, message=FALSE}
data <- s1$summ %>%
  filter(stat %in% c("empse", "modelse")) %>%
  select(model, stat, est) %>%
  pivot_wider(names_from = stat, values_from = est)

melted_data <- data %>%
  pivot_longer(cols = -model, names_to = "variable", values_to = "value")

ggplot(melted_data, aes(x = model, y = value, fill = factor(variable, levels = c("empse", "modelse")))) +
  geom_bar(stat = "identity", position = position_dodge()) +
  coord_flip() + # Makes the bar plots horizontal
  labs(y = "SE", x = "model", fill = "SE") +
  scale_fill_manual(
    values = c("empse" = "lightgray", "modelse" = "darkgray"), 
    labels = c("empse" = "Empirical SE", "modelse" = "Model SE")
  ) +
  custom_theme
ggsave(filename = "images/scenario/secompare.png")
```

